<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOKEN LIFE</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      background: #f2f2f2;
      font-family: system-ui, -apple-system, sans-serif;
    }

    h1 {
      font-size: 44px;
      margin: 0 0 32px 0;
      letter-spacing: 2px;
      text-align: center;
    }

    .header-row {
      position: relative;
      margin-bottom: 32px;
    }

    .header-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #1e3a8a; /* dark blue */
    }

    .header-button:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 32px 20px;
    }

    .token-row {
      margin-bottom: 36px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .token-label {
      font-size: 18px;
      margin-bottom: 12px;
      text-transform: uppercase;
      text-align: center;
    }

    .token-line {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .token {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      flex-shrink: 0;

      display: flex;
      align-items: center;
      justify-content: center;

      font-size: 36px;
      font-weight: 600;
      color: #000;

      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    /* TOKEN COLORS */
    .gas { background: #ffcc00; }
    .snacks { background: #8bc34a; }
    .alcohol { background: #7e57c2; }
    .other { background: #64b5f6; }
    .dunkin { background: #ff8c00; }
    .traderjoes { background: #d32f2f; }
    .meal { background: #7b1f1f; }

    .reset-button {
      margin-top: 24px;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      border: none;
      border-radius: 8px;
      background: #444;
      color: #fff;
      cursor: pointer;
      width: 100%;
    }

    .disabled {
      color: #9e9e9e !important;
    }

    .token.disabled {
      background: #d3d3d3 !important;
      box-shadow: none;
      color: #9e9e9e;
    }

    .app {
      max-width: 420px;
      margin: 0 auto;
    }

    .particle {
      position: fixed;
      width: 6px;
      height: 10px;
      border-radius: 2px;
      pointer-events: none;
      z-index: 9999;
      animation: shard-fall 900ms cubic-bezier(.2,.7,.3,1) forwards;
    }

    @keyframes shard-fall {
      0% {
        transform: translate(0, 0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform:
          translate(var(--dx), var(--dy))
          rotate(var(--rot));
        opacity: 0;
      }
    }

    /* RESET CONFIRM MODAL */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal {
      background: #fff;
      padding: 24px 22px;
      border-radius: 12px;
      width: 90%;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .modal h2 {
      margin: 0 0 16px 0;
      font-size: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .modal-cancel {
      background: #e0e0e0;
    }

    .modal-confirm {
      background: #444;
      color: #fff;
    }

    body.modal-open {
      overflow: hidden;
    }

  </style>
</head>

<body>

  <div class="app">

    <div class="header-row">
      <button
        class="header-button"
        style="right: 0;"
        onclick="undoLastMove()"
        id="undo-button"
      >
        ↶
      </button>

      <h1>TOKEN LIFE</h1>
    </div>

    <div class="token-grid">

      <div class="token-row">
        <div class="token-label" id="gas-label">GAS</div>
        <div class="token-line">
          <button class="token gas" onclick="useToken('gas')" id="gas-count">0</button>
        </div>
      </div>

      <div class="token-row">
        <div class="token-label" id="traderjoes-label">TRADER JOE’S</div>
        <div class="token-line">
          <button class="token traderjoes" onclick="useToken('traderjoes')" id="traderjoes-count">0</button>
        </div>
      </div>

      <div class="token-row">
        <div class="token-label" id="dunkin-label">DUNKIN</div>
        <div class="token-line">
          <button class="token dunkin" onclick="useToken('dunkin')" id="dunkin-count">0</button>
        </div>
      </div>

      <div class="token-row">
        <div class="token-label" id="meal-label">MEAL</div>
        <div class="token-line">
          <button class="token meal" onclick="useToken('meal')" id="meal-count">0</button>
        </div>
      </div>

      <div class="token-row">
        <div class="token-label" id="snacks-label">CANDY / SNACKS</div>
        <div class="token-line">
          <button class="token snacks" onclick="useToken('snacks')" id="snacks-count">0</button>
        </div>
      </div>

      <div class="token-row">
        <div class="token-label" id="alcohol-label">ALCOHOL</div>
        <div class="token-line">
          <button class="token alcohol" onclick="useToken('alcohol')" id="alcohol-count">0</button>
        </div>
      </div>

      <div class="token-row">
        <div class="token-label" id="other-label">OTHER</div>
        <div class="token-line">
          <button class="token other" onclick="useToken('other')" id="other-count">0</button>
        </div>
      </div>
    </div>

    <button class="reset-button" onclick="openResetModal()">
      RESET TOKENS
    </button>

  </div>

  <div id="reset-modal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h2>Reset all tokens?</h2>
      <div class="modal-buttons">
        <button class="modal-cancel" onclick="closeResetModal()">Cancel</button>
        <button class="modal-confirm" onclick="confirmReset()">Reset</button>
      </div>
    </div>
  </div>

  <script>
    const tokens = [
      'gas',
      'traderjoes',
      'dunkin',
      'meal',
      'snacks',
      'alcohol',
      'other'
    ];

    const clickSounds = [
      'SFX/Token_1.mp3',
      'SFX/Token_2.mp3',
      'SFX/Token_3.mp3',
      'SFX/Token_4.mp3',
      'SFX/Token_5.mp3'
    ];

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let clickBuffers = [];
    let lastSoundIndex = -1;
    let undoStack = [];

    const clickAudioPool = clickSounds.map(src => {
      const a = new Audio(src);
      a.preload = 'auto';
      return a;
    });

    function playClickSound() {
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }

      if (clickBuffers.length === 0) return;

      let index;
      do {
        index = Math.floor(Math.random() * clickBuffers.length);
      } while (index === lastSoundIndex && clickBuffers.length > 1);

      lastSoundIndex = index;

      const buffer = clickBuffers[index];

      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start(0);
    }

    function loadTokens() {
      tokens.forEach(t => {
        const value = parseInt(localStorage.getItem(t)) || 0;
        document.getElementById(`${t}-count`).textContent = value;
        updateDisabledState(t, value);
      });
    }

    function useToken(type) {
      let value = parseInt(localStorage.getItem(type)) || 0;
      if (value <= 0) return;

      undoStack.push({
        type,
        previousValue: value
      });

      function undoLastMove() {
        if (undoStack.length === 0) return;

        const lastMove = undoStack.pop();
        const { type, previousValue } = lastMove;

        localStorage.setItem(type, previousValue);

        const tokenEl = document.getElementById(`${type}-count`);
        tokenEl.textContent = previousValue;

        updateDisabledState(type, previousValue);
        updateUndoButton();
      }

      function updateUndoButton() {
        document.getElementById('undo-button').disabled = undoStack.length === 0;
      }

      value--;
      playClickSound();
      localStorage.setItem(type, value);
      const tokenEl = document.getElementById(`${type}-count`);
      tokenEl.textContent = value;
      spawnParticles(tokenEl);
      updateDisabledState(type, value);
      updateUndoButton();
    }

    function spawnParticles(tokenEl) {
      const rect = tokenEl.getBoundingClientRect();
      const color = getComputedStyle(tokenEl).backgroundColor;

      const shardCount = 32; // many more shards

      for (let i = 0; i < shardCount; i++) {
        const shard = document.createElement('div');
        shard.className = 'particle';
        shard.style.background = color;

        // start at token center
        shard.style.left = `${rect.left + rect.width / 2}px`;
        shard.style.top = `${rect.top + rect.height / 2}px`;

        // true radial explosion
        const angle = Math.random() * Math.PI * 2;
        const distance = 140 + Math.random() * 120;

        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;
        const rot = `${(Math.random() - 0.5) * 900}deg`;

        shard.style.setProperty('--dx', `${dx}px`);
        shard.style.setProperty('--dy', `${dy}px`);
        shard.style.setProperty('--rot', rot);

        document.body.appendChild(shard);

        setTimeout(() => shard.remove(), 900);
      }
    }

    function updateDisabledState(type, value) {
      const tokenEl = document.getElementById(`${type}-count`);
      const labelEl = document.getElementById(`${type}-label`);

      if (value === 0) {
        tokenEl.classList.add('disabled');
        labelEl.classList.add('disabled');
      } else {
        tokenEl.classList.remove('disabled');
        labelEl.classList.remove('disabled');
      }
    }

    async function loadClickSounds() {
      clickBuffers = await Promise.all(
        clickSounds.map(async src => {
          const res = await fetch(src);
          const arrayBuffer = await res.arrayBuffer();
          return await audioCtx.decodeAudioData(arrayBuffer);
        })
      );
    }

    function initDefaults() {
      if (localStorage.length === 0) {
        localStorage.setItem('gas', 7);
        localStorage.setItem('snacks', 8);
        localStorage.setItem('alcohol', 4);
        localStorage.setItem('dunkin', 6);
        localStorage.setItem('traderjoes', 3);
        localStorage.setItem('meal', 4);
        localStorage.setItem('other', 5);
      }
    }

    function openResetModal() {
      document.getElementById('reset-modal').style.display = 'flex';
      document.body.classList.add('modal-open');
    }

    function closeResetModal() {
      document.getElementById('reset-modal').style.display = 'none';
      document.body.classList.remove('modal-open');
    }

    function confirmReset() {
      closeResetModal();
      resetTokens();
    }

    function resetTokens() {
      localStorage.clear();
      undoStack = [];
      initDefaults();
      loadTokens();
      updateUndoButton();
    }
    
    loadClickSounds();
    initDefaults();
    loadTokens();
  </script>

</body>
</html>
